<!DOCTYPE html>
<html lang="hr">
<head>
    <meta charset="UTF-8">
    <title>Vremenska prognoza</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
</head>
<body id="main-body" data-weather-main="{% if weather %}{{ weather.weather[0].main|lower }}{% else %}default{% endif %}">
    <button class="theme-toggle" onclick="toggleTheme()" title="Promijeni temu">
        <span id="theme-icon">üåô</span>
    </button>
    <button class="bg-toggle" id="bg-toggle" onclick="toggleBg()" title="Dinamiƒçna pozadina">
        <span id="bg-icon">üñºÔ∏è</span>
    </button>
    <div class="container">
        <div style="text-align:center; font-size:1.2rem; margin-bottom:12px; font-weight:600; color:#007bff;">
            Dobrodo≈°li na projekat OSiRuO 2025!
        </div>
        <h1>Vremenska prognoza</h1>
        <div id="current-datetime" style="text-align:center; margin-bottom: 20px; font-weight:600;"></div>
        <form method="post" class="weather-form">
            <input type="text" name="city" id="city-input" placeholder="Unesite grad" autocomplete="off" required>
            <div id="city-suggestions" class="suggestions"></div>
            <button type="submit" class="btn btn-primary">Prika≈æi</button>
            <button type="button" id="detect-location" class="btn btn-primary" style="margin-left:10px;" title="Koristi moju lokaciju">
                <span style="font-size: 18px;">üìç</span>
            </button>
        </form>
        <div id="history" style="margin: 20px 0;"></div>

        {% if weather %}
            <div class="card mt-4">
                <div class="card-body">
                    <h2>{{ city }}</h2>
                    <div class="weather-details">
                        <div>
                            <p>üå°Ô∏è Temperatura: <strong>{{ weather.main.temp }}¬∞C</strong></p>
                            <p>ü§ó Osjeƒáaj: <strong>{{ weather.main.feels_like }}¬∞C</strong></p>
                            <p>üîª Min: <strong>{{ weather.main.temp_min }}¬∞C</strong> | üî∫ Max: <strong>{{ weather.main.temp_max }}¬∞C</strong></p>
                            <p>üíß Vla≈ænost: <strong>{{ weather.main.humidity }}%</strong></p>
                            <p>üß≠ Tlak: <strong>{{ weather.main.pressure }} hPa</strong></p>
                            <p>üëÅÔ∏è Vidljivost: <strong>{{ weather.visibility // 1000 if weather.visibility }} km</strong></p>
                            <p>‚òÅÔ∏è Oblaci: <strong>{{ weather.clouds.all if weather.clouds }}%</strong></p>
                            <p>üí® Vjetar: <strong>{{ weather.wind.speed }} m/s</strong></p>
                            <p>üåÖ Izlazak sunca: <strong>{{ weather.sunrise }}</strong></p>
                            <p>üåá Zalazak sunca: <strong>{{ weather.sunset }}</strong></p>
                            <p>üìç Koordinate: <strong>{{ weather.coord.lat }}, {{ weather.coord.lon }}</strong></p>
                        </div>
                        <div class="weather-icon">
                            <i id="main-weather-icon" class="bi" style="font-size: 3rem;"></i>
                            <p style="text-transform: capitalize;">{{ weather.weather[0].description }}</p>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}

        {% if forecast_hourly %}
            <div class="forecast-section">
                <h3>Prognoza na svaka 3 sata</h3>
                <div class="forecast-grid">
                    {% for item in forecast_hourly %}
                        <div class="forecast-card">
                            <div>{{ item.dt_txt[11:16] }}</div>
                            <i class="weather-forecast-icon bi" id="forecast-icon-{{ loop.index }}" style="font-size:2rem;"></i>
                            <div>{{ item.main.temp|round }}¬∞C</div>
                            <div style="font-size:12px;">{{ item.weather[0].description }}</div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endif %}

        {% if forecast_daily %}
            <div class="forecast-section">
                <h3>Prognoza po danima</h3>
                <div class="forecast-grid">
                    {% for item in forecast_daily %}
                        <div class="forecast-card">
                            <div><strong>{{ item.day_name }}</strong> <span style="font-size:12px;">({{ item.dt_txt[:10] }})</span></div>
                            <i class="weather-forecast-icon bi" id="forecast-icon-day-{{ loop.index }}" style="font-size:2rem;"></i>
                            <div>{{ item.main.temp|round }}¬∞C</div>
                            <div style="font-size:12px;">{{ item.weather[0].description }}</div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endif %}
    </div>
    <div id="bih-img-map" style="position: relative; width: 520px; height: 520px; margin: 30px auto; border-radius: 18px; box-shadow: 0 2px 12px #0001;">
        <img src="{{ url_for('static', filename='img/bih-3d.png') }}" alt="Mapa BiH" style="width: 100%; height: 100%; border-radius: 18px; display: block;">
     <!-- Gradovi: precizne pozicije na osnovu slike -->
    <button onclick="selectCity('Bihaƒá')" class="city-btn" style="left: 9%; top: 20%;">Bihaƒá</button>
    <button onclick="selectCity('Prijedor')" class="city-btn" style="left: 28%; top: 18%;">Prijedor</button>
    <button onclick="selectCity('Banja Luka')" class="city-btn" style="left: 38%; top: 26%;">Banja Luka</button>
    <button onclick="selectCity('Bijeljina')" class="city-btn" style="left: 88%; top: 18%;">Bijeljina</button>
    <button onclick="selectCity('Tuzla')" class="city-btn" style="left: 77%; top: 34%;">Tuzla</button>
    <button onclick="selectCity('Brƒçko')" class="city-btn" style="left: 77%; top: 25%;">Brƒçko</button>
    <button onclick="selectCity('Zenica')" class="city-btn" style="left: 58%; top: 40%;">Zenica</button>
    <button onclick="selectCity('Sarajevo')" class="city-btn" style="left: 68%; top: 55%;">Sarajevo</button>
    <button onclick="selectCity('Mostar')" class="city-btn" style="left: 53%; top: 70%;">Mostar</button>
    </div>
    <!-- Flash poruke -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="flash-messages">
          {% for category, message in messages %}
            <div class="alert alert-{{ category }}">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <script>
    // Mapiranje OpenWeatherMap icon code -> Bootstrap Icons klasa
    function getBootstrapIcon(iconCode) {
        const map = {
            "01d": "bi-sun",
            "01n": "bi-moon",
            "02d": "bi-cloud-sun",
            "02n": "bi-cloud-moon",
            "03d": "bi-cloud",
            "03n": "bi-cloud",
            "04d": "bi-clouds",
            "04n": "bi-clouds",
            "09d": "bi-cloud-drizzle",
            "09n": "bi-cloud-drizzle",
            "10d": "bi-cloud-rain",
            "10n": "bi-cloud-rain",
            "11d": "bi-cloud-lightning",
            "11n": "bi-cloud-lightning",
            "13d": "bi-snow",
            "13n": "bi-snow",
            "50d": "bi-cloud-fog2",
            "50n": "bi-cloud-fog2"
        };
        return map[iconCode] || "bi-question-circle";
    }

    // Prebaci podatke iz Jinja2 u JS varijable
    const weatherData = {{ weather|tojson|safe }};
    const forecastHourly = {{ forecast_hourly|tojson|safe }};
    const forecastDaily = {{ forecast_daily|tojson|safe }};

    document.addEventListener('DOMContentLoaded', function() {
        // Glavna ikona
        if (weatherData && weatherData.weather && weatherData.weather[0]) {
            var mainIcon = document.getElementById('main-weather-icon');
            if (mainIcon) {
                var iconCode = weatherData.weather[0].icon;
                mainIcon.className = "bi " + getBootstrapIcon(iconCode);
            }
        }

        // Prognoza po satima
        if (forecastHourly && Array.isArray(forecastHourly)) {
            forecastHourly.forEach(function(item, idx) {
                var el = document.getElementById('forecast-icon-' + (idx + 1));
                if (el && item.weather && item.weather[0]) {
                    el.className = "weather-forecast-icon bi " + getBootstrapIcon(item.weather[0].icon);
                }
            });
        }

        // Prognoza po danima
        if (forecastDaily && Array.isArray(forecastDaily)) {
            forecastDaily.forEach(function(item, idx) {
                var el = document.getElementById('forecast-icon-day-' + (idx + 1));
                if (el && item.weather && item.weather[0]) {
                    el.className = "weather-forecast-icon bi " + getBootstrapIcon(item.weather[0].icon);
                }
            });
        }
    });
    </script>
    <script>
    // Tema i pozadina
    function toggleTheme() {
        const useDynamic = localStorage.getItem('dynamicBg') !== 'false';
        const body = document.body;
        if (useDynamic) {
            body.classList.toggle('text-light');
            body.classList.toggle('text-dark');
            localStorage.setItem('theme', body.classList.contains('text-light') ? 'light' : 'dark');
        } else {
            body.classList.toggle('light');
            body.classList.toggle('dark-no-bg');
            localStorage.setItem('theme', body.classList.contains('dark-no-bg') ? 'dark' : 'light');
        }
        updateThemeIcon();
    }

    function updateThemeIcon() {
        const icon = document.getElementById('theme-icon');
        const btn = document.querySelector('.theme-toggle');
        const useDynamic = localStorage.getItem('dynamicBg') !== 'false';
        if (useDynamic) {
            if (document.body.classList.contains('text-light')) {
                icon.textContent = "‚òÄÔ∏è";
                btn.classList.add('light');
            } else {
                icon.textContent = "üåô";
                btn.classList.remove('light');
            }
        } else {
            if (document.body.classList.contains('dark-no-bg')) {
                icon.textContent = "üåô";
                btn.classList.remove('light');
            } else {
                icon.textContent = "‚òÄÔ∏è";
                btn.classList.add('light');
            }
        }
    }

    function toggleBg() {
        const useDynamic = localStorage.getItem('dynamicBg') !== 'false';
        localStorage.setItem('dynamicBg', useDynamic ? 'false' : 'true');
        applyTheme();
        updateBg();
        updateBgIcon();
    }

    function setDynamicBgClass() {
        const body = document.body;
        if (localStorage.getItem('dynamicBg') === 'false') return;
        body.className = body.className.replace(/\bweather-\w+\b/g, '').trim();
        let weatherMain = document.getElementById('main-body').getAttribute('data-weather-main');
        if (!weatherMain) weatherMain = "default";
        body.classList.add('weather-' + weatherMain.toLowerCase());
    }

    function updateBg() {
        const body = document.body;
        const useDynamic = localStorage.getItem('dynamicBg') !== 'false';
        if (!useDynamic) {
            body.className = body.className.replace(/\bweather-\w+\b/g, '').trim();
        } else {
            setDynamicBgClass();
        }
        const bgBtn = document.getElementById('bg-toggle');
        if (useDynamic) {
            bgBtn.classList.add('active');
        } else {
            bgBtn.classList.remove('active');
        }
    }

    function updateBgIcon() {
        const icon = document.getElementById('bg-icon');
        const useDynamic = localStorage.getItem('dynamicBg') !== 'false';
        icon.textContent = useDynamic ? "üñºÔ∏è" : "‚¨õ";
    }

    function applyTheme() {
        const useDynamic = localStorage.getItem('dynamicBg') !== 'false';
        const theme = localStorage.getItem('theme') || 'light';
        const body = document.body;
        body.classList.remove('light', 'dark-no-bg', 'text-light', 'text-dark');
        if (useDynamic) {
            body.classList.add('text-light');
        } else {
            if (theme === 'dark') {
                body.classList.add('dark-no-bg');
            } else {
                body.classList.add('light');
            }
        }
        updateThemeIcon();
    }

    document.addEventListener('DOMContentLoaded', function() {
        if (localStorage.getItem('dynamicBg') === null) {
            localStorage.setItem('dynamicBg', 'false');
        }
        if (localStorage.getItem('theme') === null) {
            localStorage.setItem('theme', 'light');
        }
        applyTheme();
        updateBg();
        updateBgIcon();
        // ...ostala inicijalizacija...
    });

    // Prikaz trenutnog datuma i vremena
    function updateDateTime() {
        const now = new Date();
        const dani = ["Nedjelja", "Ponedjeljak", "Utorak", "Srijeda", "ƒåetvrtak", "Petak", "Subota"];
        const mjeseci = ["januar", "februar", "mart", "april", "maj", "juni", "juli", "august", "septembar", "oktobar", "novembar", "decembar"];
        const tekst = `${dani[now.getDay()]}, ${now.getDate()}. ${mjeseci[now.getMonth()]} ${now.getFullYear()}. ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
        document.getElementById('current-datetime').textContent = tekst;
    }
    setInterval(updateDateTime, 1000);
    updateDateTime();

    // Povijest pretraga
    const form = document.querySelector('.weather-form');
    const historyDiv = document.getElementById('history');
    function renderHistory() {
        const history = JSON.parse(localStorage.getItem('weatherHistory') || '[]');
        if (history.length) {
            historyDiv.innerHTML = '<strong>Povijest pretraga:</strong> ' + history.map((h, i) =>
                `<span class="history-item" data-city="${h}" style="margin-right:8px; cursor:pointer;">${h}</span>`
            ).join('');
            document.querySelectorAll('.history-item').forEach(item => {
                item.addEventListener('click', function() {
                    document.querySelector('input[name="city"]').value = this.dataset.city;
                });
            });
        }
    }
    if(form) {
        form.addEventListener('submit', function(e) {
            const city = form.city.value.trim();
            if (city) {
                let history = JSON.parse(localStorage.getItem('weatherHistory') || '[]');
                history = history.filter(h => h.toLowerCase() !== city.toLowerCase());
                history.unshift(city);
                if (history.length > 5) history = history.slice(0,5);
                localStorage.setItem('weatherHistory', JSON.stringify(history));
            }
        });
    }
    document.addEventListener('DOMContentLoaded', renderHistory);

    // Automatsko prepoznavanje lokacije
    document.getElementById('detect-location').onclick = function() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(pos) {
                fetch(`https://nominatim.openstreetmap.org/reverse?lat=${pos.coords.latitude}&lon=${pos.coords.longitude}&format=json`)
                    .then(res => res.json())
                    .then(data => {
                        if (data.address && data.address.city) {
                            document.querySelector('input[name="city"]').value = data.address.city;
                        } else if (data.address && data.address.town) {
                            document.querySelector('input[name="city"]').value = data.address.town;
                        } else if (data.address && data.address.village) {
                            document.querySelector('input[name="city"]').value = data.address.village;
                        } else {
                            alert('Nije moguƒáe automatski prepoznati grad.');
                        }
                    });
            }, function() {
                alert('Lokacija nije dopu≈°tena.');
            });
        } else {
            alert('Va≈° preglednik ne podr≈æava geolokaciju.');
        }
    };

    // Funkcija za izbor grada sa mape
    function selectCity(cityName) {
        const input = document.getElementById('city-input');
        if (input) {
            input.value = cityName;
            input.form && input.form.submit();
        }
    }

    // Autocomplete za gradove
    const cityInput = document.getElementById('city-input');
    const suggestionsDiv = document.getElementById('city-suggestions');

    cityInput.addEventListener('input', function() {
        const value = this.value.trim();
        if (value.length < 1) {
            suggestionsDiv.style.display = 'none';
            return;
        }
        fetch(`/geo?q=${encodeURIComponent(value)}`)
            .then(res => res.json())
            .then((data) => {
                if (!data.length) {
                    suggestionsDiv.style.display = 'none';
                    return;
                }
                suggestionsDiv.innerHTML = data.map(city =>
                    `<div class="suggestion-item">${city.name}${city.state ? ', ' + city.state : ''}${city.country ? ', ' + city.country : ''}</div>`
                ).join('');
                suggestionsDiv.style.display = 'block';
            })
            .catch(() => {
                suggestionsDiv.style.display = 'none';
            });
    });

    suggestionsDiv.addEventListener('click', function(e) {
        if (e.target.classList.contains('suggestion-item')) {
            cityInput.value = e.target.textContent.split(',')[0];
            suggestionsDiv.style.display = 'none';
        }
    });

    document.addEventListener('click', function(e) {
        if (!suggestionsDiv.contains(e.target) && e.target !== cityInput) {
            suggestionsDiv.style.display = 'none';
        }
    });
    </script>
</body>
</html>